<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script type="text/javascript" src="underscore-umd.js"></script>
<script type="text/javascript" src="vue.global.js"></script>
<script type="text/javascript" src="rapydscript_web.js"></script>
<script src="ace.js" type="text/javascript" charset="utf-8"></script>
 <link rel="stylesheet" href="normalize.css"> 
<style>
    
    
.inpcode {
    grid-area: inpcode;
    border-radius: 10px;
    margin: 6px 0px 0px 6px;
    
}

.target {
    grid-area: target;
    border: solid 1px;
    border-radius: 10px;
    margin: 6px 6px 0px 0px;
    
}

.footer1 {
    grid-area: footer1;
    padding: 4px;
    margin: 0px 0px 0px 6px;
}

.footer2 {
    grid-area: footer2;
    padding: 4px;
}

.container {
    height: 100vh;
    width: 100vw;
    font-family: Arial, sans-serif;
    display: grid;
}

@media (max-width: 800px) {
    .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 6fr 4fr 30px;
        grid-template-areas:
            "target target"
            "inpcode inpcode"
            "footer1 footer2";
        gap: 6px;
    }
}
    
@media (min-width: 800px) {
    .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto 30px;
        grid-template-areas:
            "inpcode target"
            "footer1 footer2";
        gap: 6px;
    }
}
</style>

</head>


<body>
    
    <div class="container">
        <div class='inpcode' style='' id="inpcode"></div>
        <div class='target' style='' id="target"></div>
        <div class='footer1' style=''>
            <input type="checkbox" id="rt_check" name="realtime">
            <label style="margin-right:6px" for="realtime"> Live Execution</label>
            <input type="checkbox" id="wrap_check" name="wrap_check">
            <label for="wrap_check"> Wrap Text</label>
        </div>
        <div class='footer2'>
            <span id="time_exec"></span>
        </div>
    </div>
    
    
<script type="text/rapydscript">

class InputCode:
    def __init__(self):
        editor = ace.edit("inpcode");
        window.editor = editor
        self.code_el = document.getElementById("inpcode")
        self.code = editor
        self.code.setTheme("ace/theme/ambiance");
        self.code.session.setMode("ace/mode/python")
        self.storage = localStorage
        if 'rapydscript_code' not in self.storage:
            self.storage['rapydscript_code'] = """# =======================================================================
# =========================== START FROM HERE ===========================
target = document.getElementById('target')
# the DIV on the right side is of Id: 'target' (div#target)
target.innerHTML = ''
# The code in this editor is executed "oninput" (debounced 500ms)
# so the div#target must be cleared up before next execution to prevent
# unwanted behaviour
#
# The view currently appearing on the right is my created app for viewing
# the resulting javascript code (below) that compiled from rapydscript
# code (top).
# This app is created using this my rapydscript code below the line.
# Feel free to modify or erase them to play around
# 
# =======================================================================

target_styles = document.createElement('style')
target.appendChild(target_styles)
target_styles.innerHTML = '''
body {
    background-color: #555;
    color: #fff;
}

#target {
    border:none
}

div[data-v-app] {
    height: 100%;
}

.target_container {
    height: 100%;
    display: grid;
    grid-template-rows: 1fr 1fr 36px;
    grid-template-columns: 100%;
    grid-template-areas: 
      "inprs"
      "outjs"
      "exec_button";
}
'''

vue_container = document.createElement('div')
target.appendChild(vue_container)


def setup_RootComponent(props):
    code = Vue.ref('''class MyButton:

    def __init__(self, text, parent):
        self.text = text
        self.el = document.createElement("button")
        self.el.innerHTML = "MyButton"
        parent.appendChild(self.el)
        self.el.onclick = bind(self.greet, self)

    def greet(self, ev):
        alert(self.text)

mybutton = MyButton("Hello, Rapydscript!", document.getElementById("target"))''')
    compiled_code = Vue.ref('')

    def compiled():
        try:
            compiled_code.value = rapydscript.compile(this.code, {
                'beautify': True
            })
        except as exc:
            return exc.toString()
        return compiled_code.value

    def execute():
        obj = { eval }
        obj.eval(compiled_code.value)

    return {
        'code': code,
        'compiled_code': compiled_code,
        'compiled': compiled,
        'execute': execute
    }


app = Vue.createApp({
    
    setup: setup_RootComponent,

    components: {
    },

    template: '''
        <div class='target_container'>
            <div style='grid-area:inprs; border-radius:10px; margin-bottom:6px;' id='inprs' ref='inprs'></div>
            <div style='grid-area:outjs; border-radius:10px; margin-bottom:6px;' id='outjs'></div>
            <button style='grid-area:exec_button; background-color:#3D3D3D; color: white; height: 36px; border-radius: 10px; border: none'  @click='execute'>Execute</button>
        </div>
    '''
}).mount(vue_container)

window.app = app

inprs = ace.edit('inprs')
inprs.setTheme("ace/theme/ambiance")
inprs.session.setMode("ace/mode/python")
inprs.setValue(app.code)
inprs.gotoLine(inprs.session.getLength())

outjs = ace.edit('outjs')
outjs.setTheme("ace/theme/ambiance")
outjs.session.setMode("ace/mode/javascript")
outjs.setValue(app.compiled())
outjs.gotoLine(outjs.session.getLength())


def onInputCallback(ev):
    app.code = inprs.getValue()
    outjs.setValue(app.compiled())
    outjs.gotoLine(outjs.session.getLength())

inprs.session.on('change', _.debounce(onInputCallback, 500))


"""        
        self.code.setValue(self.storage['rapydscript_code'])
        setInterval(bind(self.save_code, self), 5000)
        self.disp = document.getElementById("target")
        self.rte = document.getElementById("rt_check")
        self.rte.checked = True
        self.wrp = document.getElementById("wrap_check")
        self.time_exec = document.getElementById("time_exec")
        self.code_el.onkeyup = _.debounce(bind(self.onkeyup, self), 500)
        self.rte.onclick = bind(self.code_focus, self)
        self.wrp.onclick = bind(self.wrap_text, self)
        self.code_focus()
        self.run()
    
    def save_code(self):
        self.storage['rapydscript_code'] = self.code.getValue()
    
    def wrap_text(self, ev):
        self.code.session.setUseWrapMode(not self.code.session.getUseWrapMode())
    
    def code_focus(self, ev=None):
        self.code_el.focus()

    def onkeyup(self, args=None):
        if not self.rte.checked:
            return False
        self.run()
    
    def run(self, args=None):
        t0 = new Date().getTime()
        try:
            output_code = rapydscript.compile(self.code.getValue(), {beautify: True})
            obj = { eval }; # indirect eval
            obj.eval(output_code)
        except as err:
            self.disp.innerHTML = "<pre class=\"text-red-700 text-sm\">" + err.toString() + "</pre>"
        t1 = new Date().getTime()
        self.time_exec.innerHTML = "Exec time: " + (t1 - t0) + " ms"
        return

rapydscript_editor = new InputCode()
rapydscript_editor.code.gotoLine(rapydscript_editor.code.session.getLength())
window.rapydscript_editor = rapydscript_editor

</script>


<script>
var scripts = document.getElementsByTagName('script');
for (var i=0; i<scripts.length; i++) {
    if (scripts[i].type === 'text/rapydscript') {
        var p = document.createElement('script')
        p.innerHTML = rapydscript.compile(scripts[i].innerHTML, {beautify: true});
        document.body.appendChild(p);
        document.body.removeChild(p);
    }
}
</script>
</body>

</html>
